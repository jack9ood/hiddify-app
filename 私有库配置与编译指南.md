# ç§æœ‰åº“é…ç½®ä¸ç¼–è¯‘æŒ‡å—

æœ¬æ–‡æ¡£åŒ…å«ç§æœ‰åº“é…ç½®ã€AAR ç¼–è¯‘å’Œ Flutter æ„å»ºçš„å®Œæ•´æŒ‡å—ã€‚

---

## ğŸ“‹ ç›®å½•

1. [ç§æœ‰åº“é…ç½®](#ç§æœ‰åº“é…ç½®)
2. [ç¼–è¯‘ Android AAR](#ç¼–è¯‘-android-aar)
3. [Flutter æ„å»ºè¯´æ˜](#flutter-æ„å»ºè¯´æ˜)
4. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
5. [å¿«é€Ÿå‚è€ƒ](#å¿«é€Ÿå‚è€ƒ)

---

## ç§æœ‰åº“é…ç½®

### âœ… å½“å‰é…ç½®

**å·²é…ç½®çš„ç§æœ‰åº“**ï¼š
- ä»“åº“ï¼š`github.com/jack9ood/hiddify-sing-box`
- ç‰ˆæœ¬ï¼š`v0.0.0-20251205055715-35fc725b73c1`
- é…ç½®ä½ç½®ï¼š`libcore/go.mod`

**é…ç½®å†…å®¹**ï¼š
```go
replace github.com/sagernet/sing-box => github.com/jack9ood/hiddify-sing-box v0.0.0-20251205055715-35fc725b73c1
```

### æ›´æ–°ç§æœ‰åº“

å¦‚æœä½ çš„ç§æœ‰åº“æœ‰æ–°çš„ commitï¼š

```bash
# âš ï¸ é‡è¦ï¼šå¿…é¡»åœ¨ libcore ç›®å½•ä¸‹æ‰§è¡Œ
cd libcore

# æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
go get github.com/jack9ood/hiddify-sing-box@main

# æ•´ç†ä¾èµ–
go mod tidy

# è¿”å›é¡¹ç›®æ ¹ç›®å½•
cd ..

# é‡æ–°ç¼–è¯‘ AAR
make build-android-libs
```

### éªŒè¯é…ç½®

```bash
cd libcore
go list -m github.com/jack9ood/hiddify-sing-box
```

åº”è¯¥æ˜¾ç¤ºï¼š
```
github.com/jack9ood/hiddify-sing-box v0.0.0-20251205055715-35fc725b73c1
```

### æƒé™é…ç½®

å¦‚æœé‡åˆ° GitHub ç§æœ‰åº“è®¿é—®æƒé™é—®é¢˜ï¼š

```bash
# ä½¿ç”¨ Personal Access Token
git config --global url."https://YOUR_TOKEN@github.com/".insteadOf "https://github.com/"

# æˆ–ä½¿ç”¨ SSHï¼ˆæ¨èï¼‰
git config --global url."git@github.com:".insteadOf "https://github.com/"
```

---

## ç¼–è¯‘ Android AAR

### ç¼–è¯‘å‘½ä»¤

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
cd /Users/oulei/Desktop/src/hiddify-app

# ç¼–è¯‘ Android åº“ï¼ˆä½¿ç”¨ä½ çš„ç§æœ‰åº“ï¼‰
make build-android-libs

# éªŒè¯ AAR æ–‡ä»¶
ls -lh android/app/libs/hiddify-core.aar
```

### ç¼–è¯‘è¯´æ˜

- **ç¼–è¯‘ä½ç½®**ï¼š`libcore/` ç›®å½•
- **è¾“å‡ºä½ç½®**ï¼š`android/app/libs/hiddify-core.aar`
- **ä½¿ç”¨åº“**ï¼š`github.com/jack9ood/hiddify-sing-box`ï¼ˆä½ çš„ç§æœ‰åº“ï¼‰
- **ç¼–è¯‘æ—¶é—´**ï¼šé€šå¸¸éœ€è¦ 5-15 åˆ†é’Ÿï¼Œå–å†³äºæœºå™¨æ€§èƒ½

### ç¼–è¯‘æµç¨‹

1. **å®‰è£… gomobile å·¥å…·**
   ```bash
   GOTOOLCHAIN=go1.22.3 go install github.com/sagernet/gomobile/cmd/gomobile@v0.1.1
   GOTOOLCHAIN=go1.22.3 go install github.com/sagernet/gomobile/cmd/gobind@v0.1.1
   ```

2. **ç¼–è¯‘ Android AAR**
   ```bash
   gomobile bind -v -androidapi=21 -javapkg=io.nekohasekai \
     -libname=box -tags=with_gvisor,with_quic,with_wireguard,with_ech,with_utls,with_clash_api,with_grpc \
     -trimpath -target=android \
     -o libcore/bin/libcore.aar \
     github.com/sagernet/sing-box/experimental/libbox ./mobile
   ```

3. **ç§»åŠ¨åˆ°ç›®æ ‡ç›®å½•**
   ```bash
   mv libcore/bin/libcore.aar android/app/libs/hiddify-core.aar
   ```

### é‡æ–°ç¼–è¯‘

å¦‚æœéœ€è¦é‡æ–°ç¼–è¯‘ï¼š

```bash
# æ¸…ç†ä¹‹å‰çš„æ„å»ºï¼ˆå¯é€‰ï¼‰
rm -f android/app/libs/hiddify-core.aar
rm -rf libcore/bin/*

# é‡æ–°ç¼–è¯‘
make build-android-libs
```

---

## Flutter æ„å»ºè¯´æ˜

### âš ï¸ é‡è¦ï¼šFlutter ä¸ä¼šè‡ªåŠ¨ç¼–è¯‘ AAR

**å…³é”®ç‚¹**ï¼š
- `flutter build apk --release` **ä¸ä¼šè‡ªåŠ¨ç¼–è¯‘ AAR**
- Flutter åªä¼šä½¿ç”¨å·²å­˜åœ¨çš„ AAR æ–‡ä»¶
- å¦‚æœ AAR ä¸å­˜åœ¨ï¼Œæ„å»ºä¼šå¤±è´¥
- `flutter clean` **ä¸ä¼šåˆ é™¤** AAR æ–‡ä»¶

### æ­£ç¡®çš„æ„å»ºé¡ºåº

#### æ–¹æ³•ä¸€ï¼šåˆ†æ­¥æ‰§è¡Œï¼ˆæ¨èï¼‰

```bash
# 1. å…ˆç¼–è¯‘ AARï¼ˆä½¿ç”¨ä½ çš„ç§æœ‰åº“ï¼‰
make build-android-libs

# 2. å†æ„å»º Flutter APK
flutter clean
flutter build apk --release
```

#### æ–¹æ³•äºŒï¼šä¸€æ¬¡æ€§æ‰§è¡Œ

```bash
# å…ˆç¼–è¯‘ AARï¼Œå†æ„å»º APK
make build-android-libs && flutter clean && flutter build apk --release
```

### ä½•æ—¶éœ€è¦é‡æ–°ç¼–è¯‘ AARï¼Ÿ

**éœ€è¦é‡æ–°ç¼–è¯‘çš„æƒ…å†µ**ï¼š
- âœ… æ›´æ–°äº†ç§æœ‰åº“ï¼ˆ`go get @main`ï¼‰
- âœ… ä¿®æ”¹äº† `libcore/go.mod`
- âœ… ä¿®æ”¹äº† `libcore/` ä¸­çš„ Go ä»£ç 
- âœ… ç¬¬ä¸€æ¬¡æ„å»ºé¡¹ç›®

**ä¸éœ€è¦é‡æ–°ç¼–è¯‘çš„æƒ…å†µ**ï¼š
- âœ… åªä¿®æ”¹äº† Flutter/Dart ä»£ç 
- âœ… åªä¿®æ”¹äº† Android Kotlin/Java ä»£ç 
- âœ… AAR æ–‡ä»¶å·²å­˜åœ¨ä¸”æœªè¿‡æœŸ

### éªŒè¯ AAR æ˜¯å¦å­˜åœ¨

```bash
# æ£€æŸ¥ AAR æ–‡ä»¶
ls -lh android/app/libs/hiddify-core.aar

# å¦‚æœæ–‡ä»¶å­˜åœ¨ â†’ å¯ä»¥ç›´æ¥æ„å»º Flutter
# å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ â†’ éœ€è¦å…ˆæ‰§è¡Œ make build-android-libs
```

---

## å¸¸è§é—®é¢˜

### 1. Go ç‰ˆæœ¬é—®é¢˜

**é”™è¯¯**ï¼š
```
invalid array length -delta * delta
```

**è§£å†³**ï¼šå·²åœ¨ Makefile ä¸­é…ç½® `GOTOOLCHAIN=go1.22.3`ï¼Œä¼šè‡ªåŠ¨ä¸‹è½½å¹¶ä½¿ç”¨æ­£ç¡®çš„ç‰ˆæœ¬ã€‚

### 2. npm æœªå®‰è£…

**æç¤º**ï¼š
```
npm not found, skipping npm install
```

**è¯´æ˜**ï¼šè¿™æ˜¯æ­£å¸¸çš„ï¼Œnpm åªç”¨äº protobuf ç›¸å…³åŠŸèƒ½ï¼ŒAndroid ç¼–è¯‘ä¸éœ€è¦ã€‚

### 3. gomobile å‘½ä»¤æœªæ‰¾åˆ°

**é”™è¯¯**ï¼š
```
gomobile: command not found
```

**è§£å†³**ï¼šMakefile å·²é…ç½®ä½¿ç”¨å®Œæ•´è·¯å¾„ `$(go env GOPATH)/bin/gomobile`ã€‚

### 4. ç§æœ‰åº“è®¿é—®æƒé™é—®é¢˜

å¦‚æœé‡åˆ° GitHub ç§æœ‰åº“è®¿é—®æƒé™é—®é¢˜ï¼Œå‚è€ƒä¸Šé¢çš„"æƒé™é…ç½®"éƒ¨åˆ†ã€‚

### 5. Pseudo-version é”™è¯¯

**é”™è¯¯**ï¼š
```
invalid pseudo-version: preceding tag (v1.8.8) not found
```

**åŸå› **ï¼šç§æœ‰åº“æ²¡æœ‰å¯¹åº”çš„ Git tagã€‚

**è§£å†³**ï¼šä½¿ç”¨ `go get @main` è‡ªåŠ¨è·å–æœ€æ–°ç‰ˆæœ¬ï¼ŒGo ä¼šç”ŸæˆåŸºäºå½“å‰ commit çš„ç‰ˆæœ¬å·ã€‚

---

## å¿«é€Ÿå‚è€ƒ

### å®Œæ•´æ„å»ºæµç¨‹

```bash
# 1. æ£€æŸ¥ AAR æ˜¯å¦å­˜åœ¨
ls android/app/libs/hiddify-core.aar

# 2. å¦‚æœä¸å­˜åœ¨ï¼Œå…ˆç¼–è¯‘ AAR
make build-android-libs

# 3. æ„å»º Flutter APK
flutter clean
flutter build apk --release
```

### æ›´æ–°ç§æœ‰åº“å¹¶é‡æ–°æ„å»º

```bash
# 1. æ›´æ–°ç§æœ‰åº“
cd libcore
go get github.com/jack9ood/hiddify-sing-box@main
go mod tidy
cd ..

# 2. é‡æ–°ç¼–è¯‘ AAR
make build-android-libs

# 3. é‡æ–°æ„å»º Flutter
flutter clean
flutter build apk --release
```

### åªä¿®æ”¹ Flutter ä»£ç 

```bash
# ç›´æ¥æ„å»ºå³å¯ï¼ˆAAR å·²å­˜åœ¨ï¼‰
flutter clean
flutter build apk --release
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `æ›¿æ¢åº•å±‚åº“æŒ‡å—.md` - æ›¿æ¢åº•å±‚åº“çš„è¯¦ç»†æŒ‡å—ï¼ˆåŒ…å«å…¶ä»– fork çš„ä½¿ç”¨æ–¹æ³•ï¼‰
- `ç¼–è¯‘ç¯å¢ƒ.md` - å®Œæ•´çš„ç¼–è¯‘ç¯å¢ƒé…ç½®è¯´æ˜

---

## âœ… é…ç½®æ€»ç»“

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| ç§æœ‰åº“é…ç½® | âœ… å®Œæˆ | `jack9ood/hiddify-sing-box` |
| Go å·¥å…·é“¾ | âœ… é…ç½® | Go 1.22.3 |
| ä¾èµ–æ›´æ–° | âœ… å®Œæˆ | `go mod tidy` |
| ç¼–è¯‘ç¯å¢ƒ | âœ… ä¿®å¤ | Makefile å·²æ›´æ–° |
| AAR ç¼–è¯‘ | âœ… å¯ç”¨ | é€šè¿‡ `make build-android-libs` |

---

**æç¤º**ï¼šæœ¬æ–‡æ¡£æ•´åˆäº†æ‰€æœ‰é…ç½®å’Œç¼–è¯‘ç›¸å…³çš„ä¿¡æ¯ï¼Œå»ºè®®ä½œä¸ºä¸»è¦å‚è€ƒæ–‡æ¡£ã€‚

