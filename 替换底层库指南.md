# 替换底层库（sing-box）指南

本文档说明如何替换或更新 Android 项目中的底层 sing-box 库，以支持新的协议（如 uap）。

## 📋 目录

- [架构说明](#架构说明)
- [替换步骤](#替换步骤)
- [方法一：使用支持 uap 的 sing-box fork](#方法一使用支持-uap-的-sing-box-fork)
- [方法二：修改 hiddify-sing-box fork](#方法二修改-hiddify-sing-box-fork)
- [方法三：使用本地修改的库](#方法三使用本地修改的库)
- [编译和集成](#编译和集成)
- [验证](#验证)

---

## 架构说明

### 当前架构

1. **底层库位置**：`libcore/go.mod` 中通过 `replace` 指令指向 `github.com/hiddify/hiddify-sing-box`
2. **编译方式**：使用 `gomobile bind` 将 Go 代码编译成 Android AAR 文件
3. **集成位置**：编译好的 AAR 文件位于 `android/app/libs/hiddify-core.aar`
4. **依赖关系**：
   ```
   Flutter App (Dart/Kotlin)
        ↓
   libcore (Go wrapper)
        ↓
   hiddify-sing-box (sing-box fork)
        ↓
   sing-box (原始库)
   ```

### 关键文件

- `libcore/go.mod` - Go 模块依赖配置
- `libcore/Makefile` - 编译脚本
- `android/app/libs/hiddify-core.aar` - 编译好的 Android 库
- `ios/Frameworks/Libcore.xcframework` - 编译好的 iOS 库
- `Makefile` - 项目根目录的构建脚本

---

## 替换步骤

### 方法一：使用支持 uap 的 sing-box fork

如果已经有支持 uap 协议的 sing-box fork，可以按以下步骤替换：

#### 1. 修改 `libcore/go.mod`

找到 `replace` 指令并修改：

```go
// 原来的配置
replace github.com/sagernet/sing-box => github.com/hiddify/hiddify-sing-box v1.8.9-0.20240928213625-7b79bf0c814d

// 替换为支持 uap 的 fork（示例）
replace github.com/sagernet/sing-box => github.com/your-username/sing-box-uap v1.8.9-0.20240101000000-xxxxxxxxxxxx
```

或者使用特定的 commit：

```go
replace github.com/sagernet/sing-box => github.com/your-username/sing-box-uap v1.8.9-0.20240101000000-xxxxxxxxxxxx
```

#### 2. 更新依赖

```bash
cd libcore
go mod tidy
go mod download
```

#### 3. 编译底层库

**Android**

```bash
# 在项目根目录执行
make build-android-libs
```

这个命令会：
- 进入 `libcore` 目录
- 执行 `make android` 编译 AAR 文件
- 将编译好的 `libcore.aar` 移动到 `android/app/libs/` 目录

**iOS**

```bash
# 在项目根目录执行
make build-ios-libs
```

这个命令会：
- 进入 `libcore` 目录
- 执行 `make ios` 编译 Framework 文件
- 将编译好的 `Libcore.xcframework` 移动到 `ios/Frameworks/` 目录

---

### 方法二：修改 hiddify-sing-box fork

如果你想在 hiddify-sing-box 的基础上添加 uap 支持：

#### 1. Fork hiddify-sing-box 仓库

```bash
# 访问 https://github.com/hiddify/hiddify-sing-box
# 点击 Fork 按钮创建自己的 fork
```

#### 2. 克隆你的 fork

```bash
git clone https://github.com/your-username/hiddify-sing-box.git
cd hiddify-sing-box
```

#### 3. 添加 uap 协议支持

在 fork 的仓库中添加 uap 协议的实现代码（这需要了解 sing-box 的协议扩展机制）。

#### 4. 提交并推送

```bash
git add .
git commit -m "Add UAP protocol support"
git push origin main
```

#### 5. 更新 `libcore/go.mod`

```go
replace github.com/sagernet/sing-box => github.com/your-username/hiddify-sing-box v1.8.9-0.20240101000000-xxxxxxxxxxxx
```

#### 6. 编译

**Android**

```bash
cd libcore
go mod tidy
cd ..
make build-android-libs
```

**iOS**

```bash
cd libcore
go mod tidy
cd ..
make build-ios-libs
```

---

### 方法三：使用本地修改的库

如果你想在本地开发并测试：

#### 1. 克隆 hiddify-sing-box 到本地

```bash
cd ~/workspace
git clone https://github.com/hiddify/hiddify-sing-box.git
cd hiddify-sing-box
```

#### 2. 进行修改

添加 uap 协议支持代码。

#### 3. 修改 `libcore/go.mod` 使用本地路径

```go
replace github.com/sagernet/sing-box => /Users/your-username/workspace/hiddify-sing-box
```

或者使用相对路径：

```go
replace github.com/sagernet/sing-box => ../../hiddify-sing-box
```

#### 4. 编译

**Android**

```bash
cd libcore
go mod tidy
cd ..
make build-android-libs
```

**iOS**

```bash
cd libcore
go mod tidy
cd ..
make build-ios-libs
```

---

## 编译和集成

### 完整编译流程

```bash
# 1. 确保在项目根目录
cd /Users/oulei/Desktop/src/hiddify-app

# 2. 更新 Go 依赖
cd libcore
go mod tidy
go mod download
cd ..

# 3. 编译底层库
# Android
make build-android-libs
ls -lh android/app/libs/hiddify-core.aar

# iOS
make build-ios-libs
ls -lh ios/Frameworks/Libcore.xcframework
```

### 编译选项说明

`libcore/Makefile` 中的编译命令：

**Android**

```makefile
android: lib_install
	@GOPATH=$$(go env GOPATH); $$GOPATH/bin/gomobile bind -v -androidapi=21 -javapkg=io.nekohasekai -libname=box \
		-tags=$(TAGS) -trimpath -target=android \
		-o $(BINDIR)/$(LIBNAME).aar \
		github.com/sagernet/sing-box/experimental/libbox ./mobile
```

关键参数：
- `-androidapi=21` - 最低 Android API 级别
- `-javapkg=io.nekohasekai` - Java 包名
- `-tags=$(TAGS)` - 编译标签（包含 with_gvisor, with_quic 等）
- `-target=android` - 目标平台

**iOS**

```makefile
ios: lib_install
	@GOPATH=$$(go env GOPATH); $$GOPATH/bin/gomobile bind -v -target ios -libname=box \
		-tags=$(TAGS),$(IOS_ADD_TAGS) -trimpath -ldflags="-w -s" \
		-o $(BINDIR)/Libcore.xcframework \
		github.com/sagernet/sing-box/experimental/libbox ./mobile
	cp Info.plist $(BINDIR)/Libcore.xcframework/
```

关键参数：
- `-target ios` - 目标平台（iOS）
- `-tags=$(TAGS),$(IOS_ADD_TAGS)` - 编译标签（包含 iOS 特定标签）
- `-libname=box` - 库名称

### 编译标签

当前使用的标签（在 `libcore/Makefile` 中定义）：

```makefile
TAGS=with_gvisor,with_quic,with_wireguard,with_ech,with_utls,with_clash_api,with_grpc
IOS_ADD_TAGS=with_dhcp,with_low_memory,with_conntrack
```

- `TAGS` - Android 和 iOS 通用标签
- `IOS_ADD_TAGS` - iOS 专用标签

如果需要添加新的编译标签，修改相应的变量。

---

## 验证

### 1. 检查库文件

**Android**

```bash
# 检查文件是否存在
ls -lh android/app/libs/hiddify-core.aar

# 检查文件大小（应该有几 MB）
du -h android/app/libs/hiddify-core.aar
```

**iOS**

```bash
# 检查文件是否存在
ls -lh ios/Frameworks/Libcore.xcframework

# 检查 Framework 结构
find ios/Frameworks/Libcore.xcframework -name "Libcore" -type f
```

### 2. 检查 Go 模块

```bash
cd libcore
go list -m github.com/sagernet/sing-box
```

应该显示你替换后的模块路径。

### 3. 测试编译应用

**Android**

```bash
# 清理之前的构建
flutter clean

# 获取依赖
flutter pub get

# 尝试编译（不一定要完整编译）
flutter build apk --debug
```

**iOS**

```bash
# 清理之前的构建
flutter clean

# 准备 iOS 环境（首次编译）
make ios-prepare

# 尝试编译（不一定要完整编译）
flutter build ios --debug --no-codesign
```

### 4. 验证协议支持

在应用中测试 uap 协议的配置是否能正常工作。

---

## 常见问题

### Q1: 编译失败，提示找不到模块

**解决方案**：
```bash
cd libcore
go mod tidy
go mod download
```

### Q2: gomobile 命令未找到

**解决方案**：
```bash
# 安装 gomobile（使用项目指定的版本）
GOTOOLCHAIN=go1.22.3 go install github.com/sagernet/gomobile/cmd/gomobile@v0.1.1
GOTOOLCHAIN=go1.22.3 go install github.com/sagernet/gomobile/cmd/gobind@v0.1.1

# 初始化 gomobile
export PATH="$(go env GOPATH)/bin:$PATH"
gomobile init
```

**注意**：iOS 编译需要确保 `libcore/Makefile` 中使用完整路径调用 gomobile。

### Q3: 编译时间很长

这是正常的，因为需要：
- 编译整个 Go 代码库
- 生成 JNI 绑定（Android）或 Objective-C 绑定（iOS）
- 打包成 AAR 文件（Android）或 Framework（iOS）

通常需要 5-15 分钟，取决于机器性能。

### Q4: 库文件太大

**Android AAR**

可以通过以下方式优化：
- 使用 `-ldflags="-w -s"` 去除调试信息（已在 Makefile 中）
- 检查是否有不必要的依赖

**iOS Framework**

Framework 文件通常较大，因为包含多个架构（arm64, x86_64-simulator）。这是正常的。

### Q5: 如何回退到原始版本？

修改 `libcore/go.mod` 中的 replace 指令：

```go
replace github.com/sagernet/sing-box => github.com/hiddify/hiddify-sing-box v1.8.9-0.20240928213625-7b79bf0c814d
```

然后重新编译：

```bash
# Android
make build-android-libs

# iOS
make build-ios-libs
```

---

## 注意事项

1. **版本兼容性**：确保替换的 fork 版本与当前项目兼容
2. **API 变更**：如果底层库的 API 有变更，可能需要修改 `libcore` 中的代码
3. **测试**：替换后务必进行充分测试（Android 和 iOS）
4. **备份**：替换前建议备份原始的库文件（AAR 或 Framework）
5. **Git 管理**：建议将修改后的 `go.mod` 提交到版本控制
6. **平台差异**：Android 和 iOS 使用相同的 Go 代码，但编译产物不同（AAR vs Framework）

---

## 相关资源

- [sing-box 官方文档](https://sing-box.sagernet.org/)
- [gomobile 文档](https://pkg.go.dev/golang.org/x/mobile)
- [Go Modules 文档](https://go.dev/ref/mod)

---

## 下一步

替换底层库后，还需要：

1. ✅ 在 Flutter/Dart 层添加协议支持（已完成）
2. ⏳ 在底层库中实现 uap 协议
3. ⏳ 测试协议功能
4. ⏳ 更新文档

